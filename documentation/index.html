<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2019-09-03" />
  <title>C3-Cloud Semantic Mapper</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      .smallcaps{font-variant: small-caps;}
  </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <style>
  html {
    font-size: 100%;
    overflow-y: scroll;
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
  }
  
  body {
    color: #222;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif, "Open Sans",Sans-Serif, Times, Lucida, Palatino, 'Palatino Linotype', Times, 'Times New Roman', serif;
    font-size: 12px;
    line-height: 1.2;
    padding: .5em;
    margin: auto;
    max-width: 77em;
    background: #ffffff;
  }
  
  
  
  /* a { */
  /*   color: #0645ad; */
  /*   text-decoration: none; */
  /* } */
  
  a:visited {
    color: #0b0080;
  }
  
  a:hover {
    color: #06e;
  }
  
  a:active {
    color: #faa700;
  }
  
  a:focus {
    outline: thin dotted;
  }
  
  *::-moz-selection {
    background: rgba(255, 255, 0, 0.3);
    color: #000;
  }
  
  *::selection {
    background: rgba(255, 255, 0, 0.3);
    color: #000;
  }
  
  a::-moz-selection {
    background: rgba(255, 255, 0, 0.3);
    color: #0645ad;
  }
  
  a::selection {
    background: rgba(255, 255, 0, 0.3);
    color: #0645ad;
  }
  
  p {
    margin: 1em 0;
  }
  
  img {
    max-width: 100%;
  }
  
  
  h1, h2, h3, h4, h5, h6 {
    color: #111;
    line-height: 100%;
    margin-top: 1em;
    font-weight: bolder;
  }
  
  /* h4, h5, h6 { */
  /*   font-weight: bold; */
  /* } */
  
  h1 {
    font-size: 2.5em;
  }
  
  h2 {
    font-size: 2em;
  }
  
  h3 {
    font-size: 1.5em;
  }
  
  h4 {
    font-size: 1.2em;
  }
  
  h5 {
    font-size: 1em;
  }
  
  h6 {
    font-size: 0.9em;
  }
  
  blockquote {
    color: #666666;
    margin: 0;
    padding-left: 3em;
    border-left: 0.5em #EEE solid;
  }
  
  hr {
    display: block;
    height: 2px;
    border: 0;
    border-top: 1px solid #aaa;
    border-bottom: 1px solid #eee;
    margin: 1em 0;
    padding: 0;
  }
  
  pre, code, kbd, samp {
  	color: #000;
  	background-color: #eee;
    font-family: monospace, monospace;
    _font-family: 'courier new', monospace;
    font-size: 0.98em;
  }
  
  pre {
  	padding: .5em;
  	white-space: pre;
  	white-space: pre-wrap;
  	word-wrap: break-word;
  }
  
  b, strong {
    font-weight: 500;
  }
  
  dfn {
    font-style: italic;
  }
  
  ins {
    background: #ff9;
    color: #000;
    text-decoration: none;
  }
  
  mark {
    background: #ff0;
    color: #000;
    font-style: italic;
    font-weight: bold;
  }
  
  sub, sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
  }
  
  sup {
    top: -0.5em;
  }
  
  sub {
    bottom: -0.25em;
  }
  
  ul, ol {
    margin: 1em 0;
    padding: 0 0 0 2em;
  }
  
  li p:last-child {
    margin-bottom: 0;
  }
  
  ul ul, ol ol {
    margin: .3em 0;
  }
  
  dl {
    margin-bottom: 1em;
  }
  
  dt {
    font-weight: bold;
    margin-bottom: .8em;
  }
  
  dd {
    margin: 0 0 .8em 2em;
  }
  
  dd:last-child {
    margin-bottom: 0;
  }
  
  img {
    border: 0;
    -ms-interpolation-mode: bicubic;
    vertical-align: middle;
  }
  
  figure {
    display: block;
    text-align: center;
    margin: 1em 0;
  }
  
  figure img {
    border: none;
    margin: 0 auto;
  }
  
  figcaption {
  	max-width: 50%;
  	font-size: 0.8em;
  	font-style: italic;
  	margin: 0 auto .8em;
  	
  }
  
  table {
    margin-bottom: 2em;
    border-bottom: 1px solid #ddd;
    border-right: 1px solid #ddd;
    border-spacing: 0;
    border-collapse: collapse;
  }
  
  table th {
    padding: .2em 1em;
    background-color: #eee;
    border-top: 1px solid #ddd;
    border-left: 1px solid #ddd;
  }
  
  table td {
    padding: .2em 1em;
    border-top: 1px solid #ddd;
    border-left: 1px solid #ddd;
    vertical-align: top;
  }
  
  .author {
    font-size: 1.2em;
    text-align: center;
  }
  
  @media only screen and (min-width: 480px) {
    body {
      font-size: 14px;
    }
  }
  @media only screen and (min-width: 768px) {
    body {
      font-size: 16px;
    }
  }
  @media print {
    * {
      background: transparent !important;
      color: black !important;
      filter: none !important;
      -ms-filter: none !important;
    }
  
    body {
      font-size: 12pt;
      max-width: 100%;
    }
  
    a, a:visited {
      text-decoration: underline;
    }
  
    hr {
      height: 1px;
      border: 0;
      border-bottom: 1px solid black;
    }
  
    a[href]:after {
      content: " (" attr(href) ")";
    }
  
    abbr[title]:after {
      content: " (" attr(title) ")";
    }
  
    .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after {
      content: "";
    }
  
    pre, blockquote {
      border: 1px solid #999;
      padding-right: 1em;
      page-break-inside: avoid;
    }
  
    tr, img {
      page-break-inside: avoid;
    }
  
    img {
      max-width: 100% !important;
    }
  
    @page :left {
      margin: 15mm 20mm 15mm 10mm;
  }
  
    @page :right {
      margin: 15mm 10mm 15mm 20mm;
  }
  
    p, h2, h3 {
      orphans: 3;
      widows: 3;
    }
  
    h2, h3 {
      page-break-after: avoid;
    }
  }
  .date {
    text-align: center;
    margin: 0;
  }
  
  #TOC {
    float: left;
    border: solid 1px #ccc;
    border-radius: 0.5em;
    background-color: #f2f2f2;
    width: 25%;
    padding: 1em;
    margin: 1em 1em;
  }
  #TOC ul li a {
    color: #1793d0;
  }
  
  img {
    display: block;
    margin: auto;
  }
  
  .author {
    text-align: center;
    margin: 0;
  }
  
  .title {
    text-align: center;
  }
  </style>
</head>
<body>
<header>
<h1 class="title">C3-Cloud Semantic Mapper</h1>
<p class="date">2019-09-03</p>
</header>
<nav id="TOC"> 
<p style="color:#888">Table of contents</p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#mapping-rules">Mapping Rules</a><ul>
<li><a href="#overview-1">Overview</a></li>
<li><a href="#concepts-and-sites">Concepts and sites</a></li>
<li><a href="#code-systems">Code Systems</a></li>
<li><a href="#narrower-than-broader-than">Narrower than / Broader than</a></li>
</ul></li>
<li><a href="#mapping-representation-fhir">Mapping representation: FHIR</a></li>
<li><a href="#using-the-api">Using the API</a><ul>
<li><a href="#read-only-operations">Read-only operations</a><ul>
<li><a href="#performing-a-mapping">Performing a mapping</a></li>
<li><a href="#listing-data">Listing data</a><ul>
<li><a href="#list-the-code-systems">List the code systems</a></li>
<li><a href="#list-the-codes">List the codes</a></li>
<li><a href="#list-the-concepts">List the concepts</a></li>
<li><a href="#list-the-mappings">List the mappings</a></li>
<li><a href="#list-all">List all</a></li>
</ul></li>
</ul></li>
<li><a href="#database-updates">Database updates</a><ul>
<li><a href="#api-key">API key</a></li>
<li><a href="#graphical-user-interface">Graphical User Interface</a></li>
<li><a href="#python-script-c3cloud_semanticmapper_client">Python script: c3cloud_semanticmapper_client</a><ul>
<li><a href="#spreadsheet-structure">Spreadsheet structure</a></li>
<li><a href="#script-usage">script usage</a><ul>
<li><a href="#file-structure">File structure</a><ul>
<li><a href="#yaml-configuration-example">YAML configuration example:</a></li>
</ul></li>
<li><a href="#running-the-script">Running the script</a><ul>
<li><a href="#options">Options</a></li>
<li><a href="#example">Example</a></li>
<li><a href="#output">Output</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#technical-description">Technical Description</a></li>
<li><a href="#contact">Contact</a></li>
</ul>
</nav>
<h1 id="overview">Overview</h1>
<p>The Semantic Interoperability Mapper (SIS) is part of the interoperability module of the C3-Cloud project.</p>
<p>It's purpose is to solve the issue of vocabulary disparities between the different users of the system (each user, or site, is an hospital using the application and sending patient data to the system). Different hospitals use different codes and code systems to represent medical data describing their patients. There are several code systems in use, and several national variants of code systems, presenting different levels of granularity, and translated designations of the codes. Thus, in a project such as C3-Cloud, where all the users need to send data to the system, it is needed to provide a way to understand these different codes and operate with them consistently.</p>
<p>The SIS <strong><strong>exposes manually curated mappings of medical data</strong></strong> between the different users of the C3-Cloud infrastructure . The medical data are codes of medical conditions, clinical observations, medications and other types of medical data used by the system and for which the different sites may not use the same coding system.</p>
<p>The service is a <strong><strong>REST API</strong></strong>, answering to various HTTP requests to perform the mappings and other operations such as updating the database or exploring the available mappings.</p>
<p>it is served at <a href="https://rubis.limics.upmc.fr/c3-cloud">https://rubis.limics.upmc.fr/c3-cloud</a> , where a demonstrator is available, allowing the users to explore the data, and interactively see and try different requests built via a graphical user interface, and discover the expected format of the request as well as the answer they can expect from the API.</p>
<p>This document is a more formal and thorough documentation of the service. The reader is invited to visit the abovementioned <a href="https://rubis.limics.upmc.fr/c3-cloud">demonstrator</a> for a quick overview of the system's capabilities.</p>
<h1 id="mapping-rules">Mapping Rules</h1>
<h2 id="overview-1">Overview</h2>
<p>Performing a mapping of a code from one site to another means:</p>
<ul>
<li>Finding the concept that the source's code refers to</li>
<li>Finding the corresponding code(s) for the target site for that concept</li>
<li>Returning these informations as a JSON document following the FHIR `ConceptMap` structure</li>
</ul>
<h2 id="concepts-and-sites">Concepts and sites</h2>
<p>The SIS is defines different <code>concepts</code>, denoting any data used by the C3-Cloud project and requiring to be mapped between the different sites using the application. Each <code>concept</code> has one or several corresponding <code>code system</code>, <code>code</code> and <code>designation</code> for each <code>site</code> using the system.</p>
<p>There is a special site, named <code>CDSM</code> (Clinical Decision Support Modules). This site corresponds to the C3-Cloud central representation, and is treated as any other site by the system.</p>
<figure>
<img src="images/graph_sites.png" alt="" /><figcaption>Representation of the relations of different sites. Each site (here SWFT, OSAKI, RJH, and the C3-Cloud site, CDSM) has a representation of a concept (defined by a code, code-system, and designation). To perform a mapping from a site to the C3-cloud representation, the corresponding concept is first retrieved (1), and the corresponding code(s) of the CDSM are returned (2)</figcaption>
</figure>
<h2 id="code-systems">Code Systems</h2>
<p>In order to properly identify coding systems, Uniform Resource Identifier (URI) are used. A list of uri for each code system is maintained and can be listed using the API (see chapter <a href="#list-the-code-systems">List the code systems</a>). The original document is located <a href="https://livewarwickac.sharepoint.com/sites/wmg-idh/c3-cloud/Shared%2520Documents/Forms/AllItems.aspx?viewpath=%252Fsites%252Fwmg%252Didh%252Fc3%252Dcloud%252FShared%2520Documents&amp;id=%252Fsites%252Fwmg%252Didh%252Fc3%252Dcloud%252FShared%2520Documents%252FWP6%2520Interoperability%2520Middleware%252FWP6%252DWP7%2520MAPPINGS">here</a> .</p>
<h2 id="narrower-than-broader-than">Narrower than / Broader than</h2>
<p>For each site and each code, there is a corresponding representation using the site's native code system. Depending on the granularity of the code system, one or more codes can be necessary to fully represent the Concept. When performing a mapping, it is thus necessary to specify the type of relation between the codes of the source and those of the destination.</p>
<!-- This HTML table template is generated by emacs 26.2 -->
<table border="1">
  <caption>Example of mapping for the concept Mild Depressive Episode</caption>
  <tr>
    <td rowspan="2" align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td colspan="3" align="left" valign="top">
      CDSM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td colspan="3" align="left" valign="top">
      OSAKI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;Code&nbsp;system&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      Designation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      Code&nbsp;system&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Code&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Designation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td rowspan="2" align="left" valign="top">
      &nbsp;Mild&nbsp;depressive&nbsp;episode&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SNOMED&nbsp;CT&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;310495003&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      Mild&nbsp;depression&nbsp;&nbsp;&nbsp;<br />
      (disorder)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      CIE-10-CM-ES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;F43.21&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      Trastorno&nbsp;adaptativo&nbsp;con&nbsp;<br />
      estado&nbsp;de&nbsp;ánimo&nbsp;depresivo
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      CIE-10-CM-ES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;F32.89&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      Episodio&nbsp;depresivo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      especificado&nbsp;NCOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>


<p>To perform a mapping of The SNOMED CT code <code>310495003</code> from the CDSM to OSAKI, we retrieve the Concept to which the code refers to (Mild depressive episode), and we then query the corresponding codes for OSAKI, and return all of them. Since for OSAKI two codes are necessary to fully describe the concept of mild depressive episode, and only one code is required for the CDSM, each code of OSAKI is <code>narrower than</code> the SNOMED CT code. Inversely, the SNOMED CT code is <code>broader than</code> each one of the OSAKI's CIE-10 codes.</p>
<h1 id="mapping-representation-fhir">Mapping representation: FHIR</h1>
<p>The SIS sends it's responses as JSON documents, following the <a href="https://www.hl7.org/fhir/conceptmap.html">FHIR ConceptMap specifications</a>.</p>
<h1 id="using-the-api">Using the API</h1>
<h2 id="read-only-operations">Read-only operations</h2>
<p>This section describes the endpoints and methods used by a regular user of the system, not seeking to modify data.</p>
<h3 id="performing-a-mapping">Performing a mapping</h3>
<p>This is the API's reason to exist, this endpoint represent the whole end-user functionality.</p>
<p><span class="underline">example:</span> <a href="https://rubis.limics.upmc.fr/c3-cloud/translate/?code=310495003&amp;code_system=http://snomed.info/sct&amp;fromSite=CDSM&amp;toSite=OSAKI"><code>/translate/?code=310495003&amp;code_system=http://snomed.info/sct&amp;fromSite=CDSM&amp;toSite=OSAKI</code></a></p>
<p><span class="underline">endpoint:</span> <strong><strong><code>/translate</code></strong></strong></p>
<p><span class="underline">method:</span> <strong><strong><code>GET</code></strong></strong></p>
<p><span class="underline">parameters:</span></p>
<ul>
<li><code>code_system</code> : code system's uri (see <code>GET /code-systems</code> below)</li>
<li><code>code</code> : code to translate</li>
<li><code>fromSite</code> : source site</li>
<li><code>toSite</code> : destination site</li>
</ul>
<p><span class="underline">response:</span> FHIR ConceptMap resource as a JSON document:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="dt">&quot;group&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="fu">{</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>      <span class="dt">&quot;element&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>        <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;source code&quot;</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>        <span class="dt">&quot;display&quot;</span><span class="fu">:</span> <span class="st">&quot;source code designation&quot;</span><span class="fu">,</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>        <span class="dt">&quot;target&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>          <span class="fu">{</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>            <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;target code&quot;</span><span class="fu">,</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>            <span class="dt">&quot;comment&quot;</span><span class="fu">:</span> <span class="st">&quot;description of the relation with the source code&quot;</span><span class="fu">,</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>            <span class="dt">&quot;display&quot;</span><span class="fu">:</span> <span class="st">&quot;target code designation&quot;</span><span class="fu">,</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>            <span class="dt">&quot;equivalence&quot;</span><span class="fu">:</span> <span class="st">&quot;Equal | Equivalent | Narrower | Broader&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>          <span class="fu">}</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>        <span class="ot">]</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>      <span class="fu">},</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>      <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="st">&quot;source code-system&#39;s URI&quot;</span><span class="fu">,</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>      <span class="dt">&quot;sourceVersion&quot;</span><span class="fu">:</span> <span class="st">&quot;source code-system&#39;s version&quot;</span><span class="fu">,</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>      <span class="dt">&quot;target&quot;</span><span class="fu">:</span> <span class="st">&quot;target code-system&#39;s URI&quot;</span><span class="fu">,</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>      <span class="dt">&quot;targetVersion&quot;</span><span class="fu">:</span> <span class="st">&quot;target&#39;s code-system&#39;s version&quot;</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>    <span class="fu">}</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="dt">&quot;resourceType&quot;</span><span class="fu">:</span> <span class="st">&quot;ConceptMap&quot;</span><span class="fu">,</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;human readable description of the mapping&quot;</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="fu">}</span></span>
<span id="cb1-25"><a href="#cb1-25"></a></span></code></pre></div>
<h3 id="listing-data">Listing data</h3>
<p>These endpoints can be useful to explore what the database contains, eg. to retrieve the code system's URI that should be used to construct mapping queries.</p>
<h4 id="list-the-code-systems">List the code systems</h4>
<p><span class="underline">endpoint:</span> <strong><strong><code>/code-systems</code></strong></strong></p>
<p><span class="underline">method:</span> <strong><strong><code>GET</code></strong></strong></p>
<p><span class="underline">parameters:</span> none</p>
<p><span class="underline">response:</span> JSON document containing all the code systems:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="dt">&quot;count&quot;</span><span class="fu">:</span> <span class="dv">17</span><span class="fu">,</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="fu">{</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>      <span class="dt">&quot;code_system&quot;</span><span class="fu">:</span> <span class="st">&quot;SNOMED CT&quot;</span><span class="fu">,</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>      <span class="dt">&quot;code_system_uri&quot;</span><span class="fu">:</span> <span class="st">&quot;http://snomed.info/sct&quot;</span><span class="fu">,</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>      <span class="dt">&quot;code_system_version&quot;</span><span class="fu">:</span> <span class="st">&quot;unknown&quot;</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="er">(...)</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="ot">]</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="list-the-codes">List the codes</h4>
<p><span class="underline">endpoint:</span> <strong><strong><code>/codes</code></strong></strong></p>
<p><span class="underline">method:</span> <strong><strong><code>GET</code></strong></strong></p>
<p><span class="underline">parameters:</span></p>
<ul>
<li>(optional) <code>site</code> : return only the codes used by a specific site</li>
</ul>
<p><span class="underline">response:</span> JSON document containing all the corresponding codes:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="dt">&quot;count&quot;</span><span class="fu">:</span> <span class="dv">1286</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="fu">{</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>      <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;anti_platelet&quot;</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>      <span class="dt">&quot;code_system&quot;</span><span class="fu">:</span> <span class="st">&quot;C3-Cloud&quot;</span><span class="fu">,</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>      <span class="dt">&quot;code_system_uri&quot;</span><span class="fu">:</span> <span class="st">&quot;http://www.c3-cloud.eu/fhir/clinical-concept&quot;</span><span class="fu">,</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>      <span class="dt">&quot;designation&quot;</span><span class="fu">:</span> <span class="st">&quot;Anti platelet&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="er">(...)</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="ot">]</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="list-the-concepts">List the concepts</h4>
<p><span class="underline">endpoint:</span> <strong><strong><code>/concepts</code></strong></strong></p>
<p><span class="underline">method:</span> <strong><strong><code>GET</code></strong></strong></p>
<p><span class="underline">parameters:</span> none</p>
<p><span class="underline">response:</span> JSON document containing all the concepts in the database:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="dt">&quot;count&quot;</span><span class="fu">:</span> <span class="dv">343</span><span class="fu">,</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="st">&quot;C3DP_CDSM_PROFILE|Anti platelet&quot;</span><span class="ot">,</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="st">&quot;C3DP_CDSM_PROFILE|Pioglitazone&quot;</span><span class="ot">,</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="st">&quot;C3DP_CDSM_PROFILE|Sulfonylurea allergy&quot;</span><span class="ot">,</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="st">&quot;C3DP_CDSM_PROFILE|Muscle pain&quot;</span><span class="ot">,</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="st">&quot;C3DP_CDSM_PROFILE|Angiotensin II Blockers&quot;</span><span class="ot">,</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="er">(...)</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>  <span class="ot">]</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>NB</strong> the concepts are supposed to be transparent to the user and are specific to the SIS database. They are not intended to be used by any other part of the C3-cloud project</p>
<h4 id="list-the-mappings">List the mappings</h4>
<p><span class="underline">endpoint:</span> <strong><strong><code>/mappings</code></strong></strong></p>
<p><span class="underline">method:</span> <strong><strong><code>GET</code></strong></strong></p>
<p><span class="underline">parameters:</span></p>
<ul>
<li>(optional) <code>site</code> : filter by site</li>
<li>(optional) <code>concept</code> : filter by concept</li>
</ul>
<p><span class="underline">response:</span> JSON document containing all the corresponding mappings:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="dt">&quot;count&quot;</span><span class="fu">:</span> <span class="dv">1275</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="fu">{</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>      <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;anti_platelet&quot;</span><span class="fu">,</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>      <span class="dt">&quot;code_system&quot;</span><span class="fu">:</span> <span class="st">&quot;C3-Cloud&quot;</span><span class="fu">,</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>      <span class="dt">&quot;code_system_uri&quot;</span><span class="fu">:</span> <span class="st">&quot;http://www.c3-cloud.eu/fhir/clinical-concept&quot;</span><span class="fu">,</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>      <span class="dt">&quot;concept&quot;</span><span class="fu">:</span> <span class="st">&quot;C3DP_CDSM_PROFILE|Anti platelet&quot;</span><span class="fu">,</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>      <span class="dt">&quot;designation&quot;</span><span class="fu">:</span> <span class="st">&quot;Anti platelet&quot;</span><span class="fu">,</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>      <span class="dt">&quot;site&quot;</span><span class="fu">:</span> <span class="st">&quot;CDSM&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="fu">{</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>      <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;anti_platelet&quot;</span><span class="fu">,</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>      <span class="dt">&quot;code_system&quot;</span><span class="fu">:</span> <span class="st">&quot;C3-Cloud&quot;</span><span class="fu">,</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>      <span class="dt">&quot;code_system_uri&quot;</span><span class="fu">:</span> <span class="st">&quot;http://www.c3-cloud.eu/fhir/clinical-concept&quot;</span><span class="fu">,</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>      <span class="dt">&quot;concept&quot;</span><span class="fu">:</span> <span class="st">&quot;C3DP_CDSM_PROFILE|Anti platelet&quot;</span><span class="fu">,</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>      <span class="dt">&quot;designation&quot;</span><span class="fu">:</span> <span class="st">&quot;Anti platelet&quot;</span><span class="fu">,</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>      <span class="dt">&quot;site&quot;</span><span class="fu">:</span> <span class="st">&quot;SWFT&quot;</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>    <span class="er">(...)</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="ot">]</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="list-all">List all</h4>
<p><span class="underline">endpoint:</span> <strong><strong><code>/all</code></strong></strong></p>
<p><span class="underline">method:</span> <strong><strong><code>GET</code></strong></strong></p>
<p><span class="underline">parameters:</span> none</p>
<p><span class="underline">response:</span> JSON document containing all the sites, concepts, code-systems and mappings</p>
<h2 id="database-updates">Database updates</h2>
<p>The mappings of the semantic mapper are populated from a spreadsheet available <a href="https://livewarwickac.sharepoint.com/sites/wmg-idh/c3-cloud/Shared%2520Documents/Forms/AllItems.aspx?viewpath=%252Fsites%252Fwmg%252Didh%252Fc3%252Dcloud%252FShared%2520Documents&amp;id=%252Fsites%252Fwmg%252Didh%252Fc3%252Dcloud%252FShared%2520Documents%252FWP6%2520Interoperability%2520Middleware%252FWP6%252DWP7%2520MAPPINGS">here</a>.</p>
<p>The <code>Semmaper</code> spreadsheet follows a simple structure that is used by a python script, allowing an automated synchronisation between the spreadsheet and the server directly from the client side (see below, "python script").</p>
<p><strong><strong>Any request that modifies the data must be authenticated with an API key.</strong></strong></p>
<h3 id="api-key">API key</h3>
<p>The API key is unique and can be requested by sending an email to <code>mikaeldusenne@gmail.com</code>. It should be included in a HTTP header named <code>key</code> for each request.</p>
<p>Any request not properly authenticated will result in a HTTP error 401 (Unauthorized).</p>
<h3 id="graphical-user-interface">Graphical User Interface</h3>
<p>A graphical user interface is available at <a href="https://rubis.limics.upmc.fr/c3-cloud/"><a href="https://rubis.limics.upmc.fr/c3-cloud/">https://rubis.limics.upmc.fr/c3-cloud/</a></a>. The <code>maping-editor</code> tab allows users to view and modify mappings by searching through them and editing codes. <strong><strong>NB</strong></strong> this graphical user interface was initially designed as a demonstrator of the API and might therefore lack a few functionalities, like adding a new concept or a new site to the database.</p>
<p>You should consider this tool as a quick reviewer of the data and possibly to make small modifications, but do not forget that the initial data file should be the spreadsheet in Microsoft sharepoint, and the python script below will be much more adapted to keep the spreadsheet and the server synchronized.</p>
<h3 id="python-script-c3cloud_semanticmapper_client">Python script: c3cloud_semanticmapper_client</h3>
<p>A <a href="https://github.com/mikaeldusenne/c3cloud-semanticmapper-client">python script</a> was designed with the sole purpose of parsing the manually crafted spreadsheet, check the differences with the server, and perform the necessary updates when needed. please see the link above for instructions for installing.</p>
<p>This script <strong><strong>relies heavily on the structure of the spreadsheet</strong></strong>, it is therefore imperative to follow the corresponding structure of data (see screenshot below):</p>
<h4 id="spreadsheet-structure">Spreadsheet structure</h4>
<ul>
<li>there are several sheets for different sections (e.g. Conditions, Medications )</li>
</ul>
<p>On each sheet:</p>
<ul>
<li>the first column contains the main concepts of the c3-cloud system</li>
<li>Each <code>site</code> is spread on three columns:
<ul>
<li>The first row contains the name of the site</li>
<li>on the second row <strong><strong>must</strong></strong> figure three columns: <code>Coding System</code>, <code>Code</code>, and <code>Designation</code> (these names are parsed by the script)</li>
</ul></li>
</ul>
<p><img src="images/c3cloud_spreadsheet_structure.png" /></p>
<p>It is possible to add an arbitrary number of sites next to each other as the script is going to detect them automatically.</p>
<p>Each subsequent row in these columns (therefore from row <code>3</code>) contains the data, that is, the codes for the mappings.</p>
<p><strong><strong>When several codes are needed for a mapping</strong></strong>, each code should figure on a separate row. you can insert additional rows in the spreadsheet under a specific concept without disrupting the functionality of the script. It will not affect other sites. The duplicated rows may or may not repeat the name of the concept in the <code>A</code> column (the script will infer the name from the first row)</p>
<p><img src="images/c3cloud_spreadsheet_duplicated.png" /></p>
<p><strong>Example of multiple mappings for one concept: F43.21 and F32.89 are both mapped to "mild depressive episode" for the "OSAKI" site</strong></p>
<h4 id="script-usage">script usage</h4>
<p>The script should be used from a terminal, it does not provide a graphical interface.</p>
<h5 id="file-structure">File structure</h5>
<p>The spreadsheet (and, if it needs to be updated, the terminology list) should be downloaded from the sharepoint and put in a separate folder. The folder should contain a yaml file describing <strong><strong>at least</strong></strong> :</p>
<ul>
<li>The spreadsheet path</li>
<li>The names of the sheets that need to be imported</li>
<li>The path to the api key</li>
</ul>
<p>Here is a screenshot showing, on the left side, the different files in the folder, and on the right side, the content of the corresponding <code>import.yaml</code> file:</p>
<p><img src="images/c3cloud_client_folder_structure.png" /></p>
<p>This yaml file is required as some sheets in the spreadsheet can be used for different purposes.</p>
<h6 id="yaml-configuration-example">YAML configuration example:</h6>
<p>for ease of use, you may copy and modify accordingly to your need the following content and save it in the same folder as the one containing the mapping list:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Path to the api key (a text file containing the API key)</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">api_key</span><span class="kw">:</span><span class="at"> ./apikey</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co"># spreadsheet(s) to import</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="fu">mappings</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">  # Path to the spreadsheet</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="at">  </span><span class="fu">./SemMapper-CDSMCodeMappings-with-cdsm-profile-v2.3.xlsx</span><span class="kw">:</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">    # list of the names of the sheets containing mappings</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="at">    </span><span class="fu">sheets</span><span class="kw">:</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="at">      </span><span class="kw">-</span><span class="at"> C3DP_CDSM_PROFILE</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="at">      </span><span class="kw">-</span><span class="at"> Observations</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="at">      </span><span class="kw">-</span><span class="at"> Conditions</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="at">      </span><span class="kw">-</span><span class="at"> Medications</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="at">      </span><span class="kw">-</span><span class="at"> Family History</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="at">      </span><span class="kw">-</span><span class="at"> Procedures</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="at">      </span><span class="kw">-</span><span class="at"> Immunizations</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co"># path to the csv file describing the different terminology names and their corresponding URI</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="fu">terminologies</span><span class="kw">:</span><span class="at"> terminologies.csv</span></span></code></pre></div>
<p>you may refer to <a href="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html">this link</a> for a quick introduction to the YAML syntax.</p>
<h5 id="running-the-script">Running the script</h5>
<h6 id="options">Options</h6>
<p>Several options are available to change the behaviour of the script:</p>
<ul>
<li><code>--dry-run</code> (optional) : do <strong><strong>not</strong></strong> actually send the requests, this option is useful when one wants to see what operations would be performed by the script without actually modifying anything.</li>
<li><code>--force</code> (optional) : when there is a conflict between the spreadsheet and the server, <strong><strong>overwrite</strong></strong> the server's data with the spreadsheet.</li>
<li><code>--config</code> (required) : path to the yaml configuration file</li>
<li><code>--url</code> (optional) : url of the service, should end with <code>/c3-cloud/</code></li>
</ul>
<p>Without the force option, the script will upload the <strong><strong>new</strong></strong> mappings but not overwrite a previously existing mapping containing different data.</p>
<p>the script will delete old mappings that are not present in the spreadsheet anymore.</p>
<h6 id="example">Example</h6>
<p>Here is an example of a typical run of the script:</p>
<pre class="shell"><code>python ~/Bookmarks/c3_cloud_client/c3_cloud_client/loaderScript_pandas.py \\
    --url &#39;https://rubis.limics.upmc.fr/c3-cloud/&#39; \\
    --config &#39;./c3_cloud_client/data/data_2019_07_28/import.yaml&#39; \\
    --dry-run
</code></pre>
<p>here we would simulate an import of the file(s) as specified in <code>./c3_cloud_client/data/data_2019_07_28/import.yaml</code> to the service located at <code>https://rubis.limics.upmc.fr/c3-cloud/</code> . Since we use the <code>--dry-run</code> option, the script will not perform any actual update. You can remove the <code>--dry-run</code> or replace it with <code>--force</code> depending on what you intend to do.</p>
<h6 id="output">Output</h6>
<p>The script outputs informations describing what is being performed, and displays a short summary when it finishes.</p>
<p class="heading" id="new-mappings">new mappings</p>
<pre><code>{&#39;codes&#39;: [&lt;class &#39;c3_cloud_client.objects.Code&#39;&gt;({&quot;code&quot;: &quot;F341&quot;, &quot;code_system&quot;: {&quot;code_system&quot;: &quot;ICD-10-SE&quot;, &quot;uri&quot;: &quot;urn:oid:1.2.752.116.1.1.1.1.3&quot;}, &quot;designation&quot;: &quot;Dystymi&quot;}))], &#39;concept&#39;: &#39;Family History|Dysthymia&#39;, &#39;site&#39;: &#39;RJH&#39;}
[uploading &lt;Family History|Dysthymia&gt;@&lt;RJH&gt;]
</code></pre>
<p class="heading" id="modified-mappings">modified mappings</p>
<p>This shows that the mapping for <code>Conditions|Renal outflow obstruction</code> in the <code>CDSM</code> site was already present on the server but with different data. Here we can see that the local file has a different denomination, as the mention "(disorder)" was removed in the spreadsheet. With the <code>--force</code> option, the new denomination would replace the old one in the server.</p>
<pre><code>already in db→ &lt;Conditions|Renal outflow obstruction&gt;@&lt;CDSM&gt;:[different]
local:

Conditions|Renal outflow obstruction@CDSM
 (SNOMED CT@http://snomed.info/sct):
  - (7163005) Urinary tract obstruction
server:
  - (7163005) Urinary tract obstruction (disorder)


[use --force to overwrite]

</code></pre>
<p class="heading" id="deleted-mappings">deleted mappings</p>
<pre><code>delete Conditions|Recurrent hematuria
[deleting concept Conditions|Recurrent hematuria]
</code></pre>
<p class="heading" id="summary">summary</p>
<pre><code>illegals: {&#39;&#39;, &#39;no designation&#39;, &#39;tbc by swft&#39;, &#39;no code&#39;, &#39;n/a&#39;, &#39;tbc by rjh&#39;, &#39;no coding&#39;}

identical: 1240
different: 1
new: 1
error: 0
</code></pre>
<p>The <code>illegals</code> mentions codes that have been skipped due to filtering, such as when the designation is emply or contains 'N/A' or 'TBC by …' (to be completed by …).</p>
<h1 id="technical-description">Technical Description</h1>
<p>This service is written with python 3.7, the API is deployed with Flask and the database implemented with sqlite. In order to obtain production-level performances, it is deployed with gunicorn and nginx. The nginx server is configured to use HTTPS and the certificates are generated using certbot.</p>
<p>In order to ensure easy and reproducible deployment, the application is packaged in a docker container. The container runs the nginx server and a cron task scheduling SSL certificate renewal, and is best deployed using docker-compose. It is necessary to mount <code>/etc/letsencrypt</code> for the certificates, and the <code>db</code> folder containing the sqlite database. Python dependencies are installed in the container, using a <code>requirements.txt</code></p>
<p>Tests are implemented using pytest and allow to check the correct behaviour of the different functionalities in different scenarii.</p>
<p>The API key implementation is fairly simple and relies on a single API key. any request having the ability to modify data on the server must be authenticated with the api key in the HTTP headers.</p>
<h1 id="contact">Contact</h1>
<p>If you have any question regarding the semantic mapper's functionality and usage, please send an email to <a href="mailto:mikaeldusenne@gmail.com">Mikael Dusenne</a></p>
</body>
</html>
